{% extends 'base.html' %}

{% block title %}Search Files | LGU Alubijid{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <img src="{{ url_for('static', filename='assets/logo.svg') }}" alt="Logo" height="40">
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="{{ url_for('dashboard') }}" class="{% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <i class="fas fa-home menu-icon"></i>
                    <span class="menu-text">Home</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('search_page') }}" class="{% if request.endpoint == 'search_page' %}active{% endif %}">
                    <i class="fas fa-search menu-icon"></i>
                    <span class="menu-text">Search</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('account') }}" class="{% if request.endpoint == 'account' %}active{% endif %}">
                    <i class="fas fa-user menu-icon"></i>
                    <span class="menu-text">My Account</span>
                </a>
            </li>
            {% if current_user.is_admin %}
            <li>
                <a href="{{ url_for('admin_categories') }}" class="{% if request.endpoint == 'admin_categories' %}active{% endif %}">
                    <i class="fas fa-tags menu-icon"></i>
                    <span class="menu-text">Categories</span>
                </a>
            </li>
            {% endif %}
            <li>
                <a href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt menu-icon"></i>
                    <span class="menu-text">Logout</span>
                </a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="navbar">
            <div class="d-flex align-items-center">
                <h4 class="mb-0">Search Files</h4>
            </div>

            <div class="navbar-user">
                <div class="user-icon">
                    {{ current_user.username[0].upper() }}
                </div>
                <span>{{ current_user.username }}</span>
            </div>
        </div>

        <div class="content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Filter and Sort -->
            <form method="GET" action="{{ url_for('search_page') }}">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="category">Category</label>
                        <select name="category" id="category" class="form-control">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                                <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="date">Date</label>
                        <select name="date" id="date" class="form-control">
                            <option value="all" {% if request.args.get('date') == 'all' %}selected{% endif %}>All Time</option>
                            <option value="this_month" {% if request.args.get('date') == 'this_month' %}selected{% endif %}>This Month</option>
                            <option value="this_week" {% if request.args.get('date') == 'this_week' %}selected{% endif %}>This Week</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sort_by">Sort By</label>
                        <select name="sort_by" id="sort_by" class="form-control">
                            <option value="newest" {% if request.args.get('sort_by') == 'newest' %}selected{% endif %}>Date (Newest First)</option>
                            <option value="oldest" {% if request.args.get('sort_by') == 'oldest' %}selected{% endif %}>Date (Oldest First)</option>
                            <option value="name_asc" {% if request.args.get('sort_by') == 'name_asc' %}selected{% endif %}>Name A-Z</option>
                            <option value="name_desc" {% if request.args.get('sort_by') == 'name_desc' %}selected{% endif %}>Name Z-A</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </div>
                </div>
            </form>

            <!-- Results Table -->
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>File Type</th>
                            <th>Size</th>
                            <th>Category</th>
                            <th>Uploaded By</th>
                            <th>Date Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if results %}
                            {% for file in results %}
                            <tr>
                                <td>{{ file.filename }}</td>
                                <td>{{ file.file_type }}</td>
                                <td>{{ "%.2f" % (file.file_size / 1048576) }} MB</td>
                                <td>{{ file.category.name if file.category else 'Uncategorized' }}</td>
                                <td>{{ file.user.username }}</td>
                                <td>{{ file.upload_date.strftime('%m/%d/%Y') }}</td>
                                <td>
                                    <a href="{{ url_for('download_file', file_id=file.id) }}" class="text-primary me-2"><i class="fas fa-download"></i></a>
                                    <a href="{{ url_for('edit_file', file_id=file.id) }}" class="text-warning me-2"><i class="fas fa-edit"></i></a>
                                    <a href="{{ url_for('delete_file', file_id=file.id) }}" class="text-danger"><i class="fas fa-trash-alt"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center">No results found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
